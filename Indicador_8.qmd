---
title: "Indicador_8"
format: html
---

```{r}
library(tidyr)
library(readxl)
library(ggplot2)
library(dplyr)
library(scales)
library(stringr)
```

```{r}
ruta_archivo = "C:/Users/ASUS/Documents/OPS/Final/Entregables/OPS_BBDD_FINAL_tablas_2.xlsx"
datos = read_xlsx(ruta_archivo)
```

```{r}
# 1. Definir etiquetas para los niveles de confianza
etiquetas_confianza = c(
  "1" = "Mucha",
  "2" = "Bastante", 
  "3" = "Regular",
  "4" = "Poco",
  "5" = "Nada"
)
```

```{r}
# 2. DIAGN√ìSTICO DETALLADO - Ver valores reales en las variables
cat("=== DIAGN√ìSTICO DETALLADO ===\n")

cat("\n1. Valores √∫nicos en P17_1:\n")
table(datos$P17_1, useNA = "always")

cat("\n2. Valores √∫nicos en P17_2:\n")
table(datos$P17_2, useNA = "always")

cat("\n3. Valores √∫nicos en P18:\n")
table(datos$P18, useNA = "always")

cat("\n4. Valores √∫nicos en P29 (confianza):\n")
table(datos$P29, useNA = "always")

# Verificar combinaciones espec√≠ficas
cat("\n5. Combinaci√≥n P17_1=1 y P17_2=1:\n")
combinacion_1 <- datos %>%
  filter(P17_1 == 1 & P17_2 == 1) %>%
  nrow()
cat("   Registros con P17_1=1 y P17_2=1:", combinacion_1, "\n")

cat("\n6. Combinaci√≥n P17_1=1, P17_2=1 y (P18=1 o P18 vac√≠o):\n")
combinacion_2 <- datos %>%
  filter(P17_1 == 1 & P17_2 == 1 & (P18 == 1 | is.na(P18))) %>%
  nrow()
cat("   Registros con P17_1=1, P17_2=1 y (P18=1 o vac√≠o):", combinacion_2, "\n")

cat("\n7. Combinaci√≥n P17_1=1, P17_2=1, (P18=1 o vac√≠o) y P29 no vac√≠o:\n")
combinacion_3 <- datos %>%
  filter(P17_1 == 1 & P17_2 == 1 & (P18 == 1 | is.na(P18)) & !is.na(P29) & P29 %in% 1:5) %>%
  nrow()
cat("   Registros que cumplen todos los criterios:", combinacion_3, "\n")
```

```{r}
# 3. VERIFICAR TIPO DE DATOS Y CONVERSIONES
cat("=== VERIFICACI√ìN DE TIPOS DE DATOS ===\n")

# Verificar tipos actuales
cat("Tipo de P17_1:", class(datos$P17_1), "\n")
cat("Tipo de P17_2:", class(datos$P17_2), "\n")
cat("Tipo de P18:", class(datos$P18), "\n")
cat("Tipo de P29:", class(datos$P29), "\n")

# Si son character, ver valores √∫nicos
if(is.character(datos$P17_1)) {
  cat("\nValores √∫nicos en P17_1 (como character):\n")
  print(table(datos$P17_1, useNA = "always"))
}

if(is.character(datos$P17_2)) {
  cat("\nValores √∫nicos en P17_2 (como character):\n")
  print(table(datos$P17_2, useNA = "always"))
}

if(is.character(datos$P18)) {
  cat("\nValores √∫nicos en P18 (como character):\n")
  print(table(datos$P18, useNA = "always"))
}

if(is.character(datos$P29)) {
  cat("\nValores √∫nicos en P29 (como character):\n")
  print(table(datos$P29, useNA = "always"))
}
```

```{r}
# 4. PREPARAR DATOS - TRES VERSIONES SOLICITADAS

# Funci√≥n segura para convertir a num√©rico
convertir_seguro <- function(x) {
  if(is.numeric(x)) return(x)
  if(is.character(x)) return(as.numeric(x))
  as.numeric(as.character(x))
}

# VERSI√ìN 1: TODOS los encuestados (sin filtro alguno)
datos_version1 <- datos %>%
  select(P29) %>%
  mutate(
    P29 = convertir_seguro(P29),
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    ),
    Version = "1. Total: Sin filtros"
  ) %>%
  filter(!is.na(P29) & P29 %in% 1:5)

# VERSI√ìN 2: P17_1 = 1 O P17_2 = 1 (cualquiera de los dos)
datos_version2 <- datos %>%
  select(P17_1, P17_2, P29) %>%
  mutate(
    P17_1 = convertir_seguro(P17_1),
    P17_2 = convertir_seguro(P17_2),
    P29 = convertir_seguro(P29)
  ) %>%
  # FILTRO: P17_1=1 O P17_2=1 (cualquiera de los dos)
  filter((P17_1 == 1 | P17_2 == 1) & !is.na(P29) & P29 %in% 1:5) %>%
  mutate(
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    ),
    Version = "2. P17_1=1 o P17_2=1"
  )

# VERSI√ìN 3: P18=1 o P18 vac√≠o
datos_version3 <- datos %>%
  select(P18, P29) %>%
  mutate(
    P18 = convertir_seguro(P18),
    P29 = convertir_seguro(P29)
  ) %>%
  # FILTRO: P18=1 o P18 vac√≠o
  filter((P18 == 1 | is.na(P18)) & !is.na(P29) & P29 %in% 1:5) %>%
  mutate(
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    ),
    Version = "3. P18=1 o vac√≠o"
  )

# Combinar todos los datasets
datos_confianza_completo <- bind_rows(
  datos_version1,
  datos_version2,
  datos_version3
)

# Verificar los datos
cat("=== VERIFICACI√ìN DE LAS TRES VERSIONES ===\n")
cat("‚Ä¢ Versi√≥n 1 - Sin filtros:", nrow(datos_version1), "\n")
cat("‚Ä¢ Versi√≥n 2 - P17_1=1 o P17_2=1:", nrow(datos_version2), "\n")
cat("‚Ä¢ Versi√≥n 3 - P18=1 o vac√≠o:", nrow(datos_version3), "\n")
```

```{r}
# 5. GR√ÅFICOS INDIVIDUALES - TRES VERSIONES (BASADO EN TU C√ìDIGO FUNCIONAL)

# Funci√≥n mejorada basada en tu c√≥digo que funciona
crear_grafico_confianza_individual <- function(datos_filtrados, titulo_version, base_n_version) {
  
  if(nrow(datos_filtrados) == 0) {
    cat("No hay datos para:", titulo_version, "\n")
    return(NULL)
  }
  
  # Calcular frecuencias y porcentajes (igual que en tu c√≥digo funcional)
  total_encuestados <- nrow(datos_filtrados)
  
  datos_agregados <- datos_filtrados %>%
    group_by(Nivel_Confianza) %>%
    summarise(
      Frecuencia = n(),
      .groups = 'drop'
    ) %>%
    mutate(
      Porcentaje = Frecuencia / total_encuestados,
      # Orden para el gr√°fico (de mayor a menor confianza)
      Orden = case_when(
        Nivel_Confianza == "Mucha" ~ 1,
        Nivel_Confianza == "Bastante" ~ 2,
        Nivel_Confianza == "Regular" ~ 3,
        Nivel_Confianza == "Poco" ~ 4,
        Nivel_Confianza == "Nada" ~ 5
      )
    ) %>%
    arrange(Orden)
  
  # Base N para etiqueta (igual que en tu c√≥digo funcional)
  base_n_confianza <- data.frame(
    Categoria = "Confianza",
    Base_N = base_n_version,
    Posicion_Etiqueta = 1.0
  )
  
  # CREAR EL GR√ÅFICO (igual que tu c√≥digo funcional pero con t√≠tulo din√°mico)
  ggplot(datos_agregados, aes(x = "Confianza", y = Porcentaje, fill = reorder(Nivel_Confianza, -Orden))) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE), width = 0.6) +
    
    # Etiquetas de porcentaje (MISMA L√ìGICA QUE TU C√ìDIGO FUNCIONAL)
    geom_text(aes(label = percent(Porcentaje, accuracy = 1)),
              position = position_stack(vjust = 0.5, reverse = TRUE),
              color = "white",
              fontface = "bold",
              size = 4) +
    
    # Etiqueta de Base N (MISMA L√ìGICA QUE TU C√ìDIGO FUNCIONAL)
    geom_text(data = base_n_confianza,
              aes(x = Categoria, y = Posicion_Etiqueta, label = paste0("N = ", Base_N)),
              inherit.aes = FALSE,
              hjust = -0.1,
              size = 4,
              fontface = "bold") +
    
    # Paleta de colores (LA TUYA ORIGINAL)
    scale_fill_manual(
      values = c(
        "Mucha" = "#4fa8d9",
        "Bastante" = "#0077b6",  
        "Regular" = "#005596",
        "Poco" = "#00406d",
        "Nada" = "#002b4a"
      ),
      name = "Nivel de confianza"
    ) +
    
    guides(fill = guide_legend(nrow = 1)) +
    
    scale_y_continuous(
      labels = percent,
      expand = expansion(mult = c(0, 0.15))
    ) +
    
    coord_flip() +
    labs(
      title = "Confianza en proveedores de salud p√∫blico\ny en los tratamientos que prescriben",
      x = "",
      y = "Distribuci√≥n porcentual"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold", margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
      axis.text.y = element_blank(),
      axis.text.x = element_text(size = 10),
      legend.position = "bottom",
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 20, r = 40, b = 20, l = 15)
    )
}

# Generar los tres gr√°ficos individuales
cat("=== GENERANDO GR√ÅFICOS INDIVIDUALES ===\n")

# Gr√°fico 1: Sin filtros (todos los datos)
datos_version1 <- datos %>%
  # Filtrar respuestas v√°lidas de P29
  filter(!is.na(P29) & P29 %in% 1:5) %>%
  mutate(
    P29 = as.numeric(P29),
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    )
  )

if(nrow(datos_version1) > 0) {
  grafico1 <- crear_grafico_confianza_individual(
    datos_version1, 
    "Confianza - TODOS los encuestados (sin filtros)",
    nrow(datos_version1)
  )
  print(grafico1)
} else {
  cat("No hay datos para Versi√≥n 1\n")
}

# Gr√°fico 2: P17_1=1 o P17_2=1
datos_version2 <- datos %>%
  filter(P17_1 == 1 | P17_2 == 1) %>%
  # Filtrar respuestas v√°lidas de P29
  filter(!is.na(P29) & P29 %in% 1:5) %>%
  mutate(
    P29 = as.numeric(P29),
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    )
  )

if(nrow(datos_version2) > 0) {
  grafico2 <- crear_grafico_confianza_individual(
    datos_version2, 
    "Confianza - P17_1=1 o P17_2=1", 
    nrow(datos_version2)
  )
  print(grafico2)
} else {
  cat("No hay datos para Versi√≥n 2\n")
}

# Gr√°fico 3: P18=1 o vac√≠o
datos_version3 <- datos %>%
  filter(P18 == 1 | is.na(P18)) %>%
  # Filtrar respuestas v√°lidas de P29
  filter(!is.na(P29) & P29 %in% 1:5) %>%
  mutate(
    P29 = as.numeric(P29),
    Nivel_Confianza = factor(
      as.character(P29),
      levels = names(etiquetas_confianza),
      labels = etiquetas_confianza
    )
  )

if(nrow(datos_version3) > 0) {
  grafico3 <- crear_grafico_confianza_individual(
    datos_version3, 
    "Confianza - P18=1 o vac√≠o", 
    nrow(datos_version3)
  )
  print(grafico3)
} else {
  cat("No hay datos para Versi√≥n 3\n")
}
```

```{r}
# 6. GR√ÅFICO COMPARATIVO DE LAS TRES VERSIONES

# Calcular datos para gr√°fico comparativo
datos_comparativo <- datos_confianza_completo %>%
  group_by(Version, Nivel_Confianza) %>%
  summarise(Frecuencia = n(), .groups = 'drop') %>%
  group_by(Version) %>%
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia),
    Orden = case_when(
      Nivel_Confianza == "Mucha" ~ 1,
      Nivel_Confianza == "Bastante" ~ 2,
      Nivel_Confianza == "Regular" ~ 3,
      Nivel_Confianza == "Poco" ~ 4,
      Nivel_Confianza == "Nada" ~ 5
    )
  ) %>%
  arrange(Version, Orden)

# Calcular posiciones para etiquetas
datos_comparativo <- datos_comparativo %>%
  group_by(Version) %>%
  mutate(
    posicion_acumulada = cumsum(Porcentaje) - Porcentaje/2
  ) %>%
  ungroup()

# Bases N para etiquetas
base_n_comparativo <- datos_confianza_completo %>%
  group_by(Version) %>%
  summarise(Base_N = n(), .groups = 'drop')

# Gr√°fico comparativo
if(nrow(datos_comparativo) > 0) {
  ggplot(datos_comparativo, aes(x = Version, y = Porcentaje, fill = reorder(Nivel_Confianza, -Orden))) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE), width = 0.7) +
    
    # Etiquetas de porcentaje
    geom_text(aes(label = percent(Porcentaje, accuracy = 1), y = posicion_acumulada),
              color = "white",
              fontface = "bold",
              size = 3.5) +
    
    # Etiquetas de Base N
    geom_text(data = base_n_comparativo,
              aes(x = Version, y = 1.05, label = paste0("N=", Base_N)),
              inherit.aes = FALSE,
              size = 4,
              fontface = "bold") +
    
    scale_fill_manual(
      values = c(
        "Mucha" = "#4fa8d9",
        "Bastante" = "#0077b6",  
        "Regular" = "#005596",
        "Poco" = "#00406d",
        "Nada" = "#002b4a"
      ),
      name = "Nivel de confianza"
    ) +
    
    guides(fill = guide_legend(nrow = 1)) +
    
    scale_y_continuous(
      labels = percent,
      limits = c(0, 1.1),
      expand = c(0, 0)
    ) +
    
    coord_flip() +
    labs(
      title = "Proporci√≥n de la poblaci√≥n M&R que expresa confianza en los proveedores de salud o en el tratamiento prescrito",
      x = "",
      y = "Distribuci√≥n porcentual"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold", margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
      axis.text.y = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(size = 10),
      legend.position = "bottom",
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
    )
} else {
  cat("No hay datos para generar el gr√°fico comparativo\n")
}
```
```{r}
# 7. EXPORTACI√ìN A EXCEL - TABLAS BASE DE LOS TRES GR√ÅFICOS
library(openxlsx)

# Crear workbook
wb <- createWorkbook()

# Hoja 1: Resumen general comparativo
tabla_resumen_comparativo <- datos_comparativo %>%
  mutate(Porcentaje_Formateado = percent(Porcentaje, accuracy = 0.1)) %>%
  select(Version, Nivel_Confianza, Frecuencia, Porcentaje, Porcentaje_Formateado)

addWorksheet(wb, "01_Resumen_Comparativo")
writeDataTable(wb, "01_Resumen_Comparativo", tabla_resumen_comparativo)

# Hoja 2: Datos detallados Versi√≥n 1 (Sin filtros)
tabla_version1_detalle <- datos_version1 %>%
  select(Nivel_Confianza) %>%
  mutate(Version = "1. Total: Sin filtros")

addWorksheet(wb, "02_Version1_SinFiltros")
writeDataTable(wb, "02_Version1_SinFiltros", tabla_version1_detalle)

# Hoja 3: Datos detallados Versi√≥n 2 (P17_1=1 o P17_2=1)
if(nrow(datos_version2) > 0) {
  tabla_version2_detalle <- datos_version2 %>%
    select(P17_1, P17_2, Nivel_Confianza) %>%
    mutate(Version = "2. P17_1=1 o P17_2=1")
  
  addWorksheet(wb, "03_Version2_P17_1_o_P17_2")
  writeDataTable(wb, "03_Version2_P17_1_o_P17_2", tabla_version2_detalle)
}

# Hoja 4: Datos detallados Versi√≥n 3 (P18=1 o vac√≠o)
if(nrow(datos_version3) > 0) {
  tabla_version3_detalle <- datos_version3 %>%
    select(P18, Nivel_Confianza) %>%
    mutate(Version = "3. P18=1 o vac√≠o")
  
  addWorksheet(wb, "04_Version3_P18_1_o_Vacio")
  writeDataTable(wb, "04_Version3_P18_1_o_Vacio", tabla_version3_detalle)
}

# Hoja 5: Metodolog√≠a y criterios
metodologia <- data.frame(
  Version = c(
    "1. Total: Sin filtros",
    "2. P17_1=1 o P17_2=1", 
    "3. P18=1 o vac√≠o"
  ),
  Criterio_Inclusion = c(
    "Todos los encuestados que respondieron P29 (nivel de confianza)",
    "Encuestados que respondieron 'S√≠' en P17_1 (conf√≠a en proveedores p√∫blicos) O 'S√≠' en P17_2 (conf√≠a en tratamientos)",
    "Encuestados que respondieron P18=1 (recibi√≥ tratamiento) o P18 vac√≠o (no se registr√≥ respuesta)"
  ),
  Base_N = c(
    nrow(datos_version1),
    nrow(datos_version2),
    nrow(datos_version3)
  ),
  Descripcion_Variables = c(
    "P29: Nivel de confianza general (1=Mucha, 5=Nada)",
    "P17_1: Confianza en proveedores de salud p√∫blico\nP17_2: Confianza en tratamientos que prescriben",
    "P18: ¬øRecibi√≥ tratamiento? (1=S√≠, NA=No respondido/vac√≠o)"
  )
)

addWorksheet(wb, "05_Metodologia")
writeDataTable(wb, "05_Metodologia", metodologia)

# Hoja 6: Estad√≠sticas descriptivas
estadisticas <- data.frame(
  Metrica = c(
    "Total encuestados en base original",
    "Versi√≥n 1 - Sin filtros",
    "Versi√≥n 2 - P17_1=1 o P17_2=1",
    "Versi√≥n 3 - P18=1 o vac√≠o",
    "Porcentaje 'Mucha confianza' - Versi√≥n 1",
    "Porcentaje 'Mucha confianza' - Versi√≥n 2", 
    "Porcentaje 'Mucha confianza' - Versi√≥n 3",
    "Porcentaje 'Mucha + Bastante confianza' - Versi√≥n 1",
    "Porcentaje 'Mucha + Bastante confianza' - Versi√≥n 2",
    "Porcentaje 'Mucha + Bastante confianza' - Versi√≥n 3"
  ),
  Valor = c(
    nrow(datos),
    nrow(datos_version1),
    nrow(datos_version2),
    nrow(datos_version3),
    percent(filter(tabla_resumen_comparativo, Version == "1. Total: Sin filtros" & Nivel_Confianza == "Mucha")$Porcentaje, accuracy = 0.1),
    ifelse(nrow(datos_version2) > 0, 
           percent(filter(tabla_resumen_comparativo, Version == "2. P17_1=1 o P17_2=1" & Nivel_Confianza == "Mucha")$Porcentaje, accuracy = 0.1),
           "N/A"),
    ifelse(nrow(datos_version3) > 0,
           percent(filter(tabla_resumen_comparativo, Version == "3. P18=1 o vac√≠o" & Nivel_Confianza == "Mucha")$Porcentaje, accuracy = 0.1),
           "N/A"),
    # Mucha + Bastante confianza
    percent(sum(filter(tabla_resumen_comparativo, Version == "1. Total: Sin filtros" & Nivel_Confianza %in% c("Mucha", "Bastante"))$Porcentaje), accuracy = 0.1),
    ifelse(nrow(datos_version2) > 0,
           percent(sum(filter(tabla_resumen_comparativo, Version == "2. P17_1=1 o P17_2=1" & Nivel_Confianza %in% c("Mucha", "Bastante"))$Porcentaje), accuracy = 0.1),
           "N/A"),
    ifelse(nrow(datos_version3) > 0,
           percent(sum(filter(tabla_resumen_comparativo, Version == "3. P18=1 o vac√≠o" & Nivel_Confianza %in% c("Mucha", "Bastante"))$Porcentaje), accuracy = 0.1),
           "N/A")
  )
)

addWorksheet(wb, "06_Estadisticas")
writeDataTable(wb, "06_Estadisticas", estadisticas)

# Hoja 7: Datos completos para an√°lisis
datos_completos_export <- datos_confianza_completo %>%
  select(Version, Nivel_Confianza)

addWorksheet(wb, "07_Datos_Completos")
writeDataTable(wb, "07_Datos_Completos", datos_completos_export)

# Aplicar formatos
headerStyle <- createStyle(
  textDecoration = "bold", fgFill = "#4fa8d9", fontColour = "white",
  border = "TopBottomLeftRight", borderColour = "#002b4a"
)

# Aplicar estilo a todas las hojas
hojas <- sheets(wb)
for (hoja in hojas) {
  addStyle(wb, hoja, headerStyle, rows = 1, cols = 1:10, gridExpand = TRUE)
  setColWidths(wb, hoja, cols = 1:10, widths = "auto")
}

# Guardar archivo
ruta_excel_confianza <- "C:/Users/ASUS/Documents/OPS/Final/Entregables/Tablas_Base_Confianza_Tres_Versiones.xlsx"
saveWorkbook(wb, ruta_excel_confianza, overwrite = TRUE)

cat("‚úÖ EXPORTACI√ìN COMPLETADA\n")
cat("üìä Archivo Excel generado:", ruta_excel_confianza, "\n")
cat("üìã Hojas incluidas:\n")
for(hoja in hojas) {
  cat("  ‚Ä¢", hoja, "\n")
}
cat("\nüìà RESUMEN DE VERSIONES:\n")
cat("  ‚Ä¢ Versi√≥n 1 (Sin filtros):", nrow(datos_version1), "personas\n")
cat("  ‚Ä¢ Versi√≥n 2 (P17_1=1 o P17_2=1):", nrow(datos_version2), "personas\n")
cat("  ‚Ä¢ Versi√≥n 3 (P18=1 o vac√≠o):", nrow(datos_version3), "personas\n")
```




