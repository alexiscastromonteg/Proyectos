---
title: "Indicador_9"
format: html
---

```{r}
library(tidyr)
library(readxl)
library(ggplot2)
library(dplyr)
library(scales)
library(stringr)
library(openxlsx)
```

```{r}
ruta_archivo = "C:/Users/ASUS/Documents/OPS/Final/Entregables/OPS_BBDD_FINAL_tablas_2.xlsx"
datos = read_xlsx(ruta_archivo)
```

```{r}
# 1. DIAGNÓSTICO DETALLADO - Ver valores reales en las variables
cat("=== DIAGNÓSTICO DETALLADO P30 ===\n")

cat("\n1. Valores únicos en P17_1:\n")
table(datos$P17_1, useNA = "always")

cat("\n2. Valores únicos en P17_2:\n")
table(datos$P17_2, useNA = "always")

cat("\n3. Valores únicos en P18:\n")
table(datos$P18, useNA = "always")

cat("\n4. Valores únicos en P30 (discriminación):\n")
table(datos$P30, useNA = "always")

# Verificar combinaciones específicas
cat("\n5. Combinación P17_1=1 y P17_2=1:\n")
combinacion_1 <- datos %>%
  filter(P17_1 == 1 & P17_2 == 1) %>%
  nrow()
cat("   Registros con P17_1=1 y P17_2=1:", combinacion_1, "\n")

cat("\n6. Combinación P17_1=1, P17_2=1 y P30 no vacío:\n")
combinacion_2 <- datos %>%
  filter(P17_1 == 1 & P17_2 == 1 & !is.na(P30) & P30 %in% 1:3) %>%
  nrow()
cat("   Registros con P17_1=1, P17_2=1 y P30 válido:", combinacion_2, "\n")

cat("\n7. Combinación P18=1 o vacío y P30 no vacío:\n")
combinacion_3 <- datos %>%
  filter((P18 == 1 | is.na(P18)) & !is.na(P30) & P30 %in% 1:3) %>%
  nrow()
cat("   Registros con P18=1 o vacío y P30 válido:", combinacion_3, "\n")
```

```{r}
# 2. DEFINIR ETIQUETAS Y PALETA

# Etiquetas para P30 (solo 1, 2, 3)
etiquetas_p30 = c(
  "1" = "Siempre",
  "2" = "Frecuentemente", 
  "3" = "Algunas veces"
)

# Paleta de azules para 3 categorías
paleta_discriminacion = c(
  "Siempre" = "#002b4a",        # Azul más oscuro
  "Frecuentemente" = "#0077b6", # Azul medio  
  "Algunas veces" = "#4fa8d9"   # Azul claro
)
```

```{r}
# 3. PREPARAR DATOS - TRES VERSIONES SOLICITADAS

# Función segura para convertir a numérico
convertir_seguro <- function(x) {
  if(is.numeric(x)) return(x)
  if(is.character(x)) return(as.numeric(x))
  as.numeric(as.character(x))
}

# VERSIÓN 1: TODOS los encuestados (sin filtro alguno)
datos_version1 <- datos %>%
  select(P30) %>%
  mutate(
    P30 = convertir_seguro(P30)
  ) %>%
  # FILTRO: Solo respuestas 1, 2, 3 en P30
  filter(!is.na(P30) & P30 %in% 1:3) %>%
  mutate(
    Respuesta = factor(
      as.character(P30),
      levels = names(etiquetas_p30),
      labels = etiquetas_p30
    ),
    Version = "1. Total: Sin filtros"
  )

# VERSIÓN 2: P17_1 = 1 O P17_2 = 1 (cualquiera de los dos)
datos_version2 <- datos %>%
  select(P17_1, P17_2, P30) %>%
  mutate(
    P17_1 = convertir_seguro(P17_1),
    P17_2 = convertir_seguro(P17_2),
    P30 = convertir_seguro(P30)
  ) %>%
  # FILTRO: P17_1=1 O P17_2=1 (cualquiera de los dos) Y P30 en 1,2,3
  filter((P17_1 == 1 | P17_2 == 1) & !is.na(P30) & P30 %in% 1:3) %>%
  mutate(
    Respuesta = factor(
      as.character(P30),
      levels = names(etiquetas_p30),
      labels = etiquetas_p30
    ),
    Version = "2. P17_1=1 o P17_2=1"
  )

# VERSIÓN 3: P18=1 o P18 vacío
datos_version3 <- datos %>%
  select(P18, P30) %>%
  mutate(
    P18 = convertir_seguro(P18),
    P30 = convertir_seguro(P30)
  ) %>%
  # FILTRO: P18=1 o P18 vacío Y P30 en 1,2,3
  filter((P18 == 1 | is.na(P18)) & !is.na(P30) & P30 %in% 1:3) %>%
  mutate(
    Respuesta = factor(
      as.character(P30),
      levels = names(etiquetas_p30),
      labels = etiquetas_p30
    ),
    Version = "3. P18=1 o vacío"
  )

# Combinar todos los datasets
datos_p30_completo <- bind_rows(
  datos_version1,
  datos_version2,
  datos_version3
)

# Verificar los datos
cat("=== VERIFICACIÓN DE LAS TRES VERSIONES P30 ===\n")
cat("• Versión 1 - Sin filtros:", nrow(datos_version1), "\n")
cat("• Versión 2 - P17_1=1 o P17_2=1:", nrow(datos_version2), "\n")
cat("• Versión 3 - P18=1 o vacío:", nrow(datos_version3), "\n")
```

```{r}
# 4. GRÁFICOS INDIVIDUALES - TRES VERSIONES

# Función para crear gráficos individuales de P30
crear_grafico_p30_individual <- function(datos_filtrados, titulo_version, base_n_version) {
  
  if(nrow(datos_filtrados) == 0) {
    cat("No hay datos para:", titulo_version, "\n")
    return(NULL)
  }
  
  # Calcular frecuencias y porcentajes
  total_encuestados <- nrow(datos_filtrados)
  
  datos_agregados <- datos_filtrados %>%
    group_by(Respuesta) %>%
    summarise(
      Frecuencia = n(),
      .groups = 'drop'
    ) %>%
    mutate(
      Porcentaje = Frecuencia / total_encuestados,
      # Orden para el gráfico (de mayor a menor frecuencia de discriminación)
      Orden = case_when(
        Respuesta == "Siempre" ~ 1,
        Respuesta == "Frecuentemente" ~ 2,
        Respuesta == "Algunas veces" ~ 3
      )
    ) %>%
    arrange(Orden)
  
  # Base N para etiqueta
  base_n_p30 <- data.frame(
    Categoria = "Discriminación",
    Base_N = base_n_version,
    Posicion_Etiqueta = 1.0
  )
  
  # CREAR EL GRÁFICO
  ggplot(datos_agregados, aes(x = "Percepción", y = Porcentaje, fill = reorder(Respuesta, -Orden))) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE), width = 0.6) +
    
    # Etiquetas de porcentaje
    geom_text(aes(label = percent(Porcentaje, accuracy = 1)),
              position = position_stack(vjust = 0.5, reverse = TRUE),
              color = "white",
              fontface = "bold",
              size = 4) +
    
    # Etiqueta de Base N
    geom_text(data = base_n_p30,
              aes(x = "Percepción", y = Posicion_Etiqueta, label = paste0("N = ", Base_N)),
              inherit.aes = FALSE,
              hjust = -0.1,
              size = 4,
              fontface = "bold") +
    
    # Paleta de colores
    scale_fill_manual(
      values = paleta_discriminacion,
      name = ""
    ) +
    
    guides(fill = guide_legend(nrow = 1)) +
    
    scale_y_continuous(
      labels = percent,
      expand = expansion(mult = c(0, 0.15))
    ) +
    
    coord_flip() +
    labs(
      title = "Percepción de atención discriminatoria o excluyente\nen establecimientos de salud",
      x = "",
      y = "¿Considera que el personal de salud brinda una atención\ndiscriminatoria o excluyente por ser migrante o refugiado?"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold", margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
      axis.text.y = element_blank(),
      axis.text.x = element_text(size = 10),
      legend.position = "bottom",
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 20, r = 40, b = 20, l = 15)
    )
}

# Generar los tres gráficos individuales
cat("=== GENERANDO GRÁFICOS INDIVIDUALES P30 ===\n")

# Gráfico 1: Sin filtros (todos los datos)
if(nrow(datos_version1) > 0) {
  grafico1 <- crear_grafico_p30_individual(
    datos_version1, 
    "Percepción discriminación - TODOS los encuestados (sin filtros)",
    nrow(datos_version1)
  )
  print(grafico1)
} else {
  cat("No hay datos para Versión 1\n")
}

# Gráfico 2: P17_1=1 o P17_2=1
if(nrow(datos_version2) > 0) {
  grafico2 <- crear_grafico_p30_individual(
    datos_version2, 
    "Percepción discriminación - P17_1=1 o P17_2=1", 
    nrow(datos_version2)
  )
  print(grafico2)
} else {
  cat("No hay datos para Versión 2\n")
}

# Gráfico 3: P18=1 o vacío
if(nrow(datos_version3) > 0) {
  grafico3 <- crear_grafico_p30_individual(
    datos_version3, 
    "Percepción discriminación - P18=1 o vacío", 
    nrow(datos_version3)
  )
  print(grafico3)
} else {
  cat("No hay datos para Versión 3\n")
}
```

```{r}
# 5. GRÁFICO COMPARATIVO DE LAS TRES VERSIONES

# Calcular datos para gráfico comparativo
datos_comparativo <- datos_p30_completo %>%
  group_by(Version, Respuesta) %>%
  summarise(Frecuencia = n(), .groups = 'drop') %>%
  group_by(Version) %>%
  mutate(
    Porcentaje = Frecuencia / sum(Frecuencia),
    Orden = case_when(
      Respuesta == "Siempre" ~ 1,
      Respuesta == "Frecuentemente" ~ 2,
      Respuesta == "Algunas veces" ~ 3
    )
  ) %>%
  arrange(Version, Orden)

# Calcular posiciones para etiquetas
datos_comparativo <- datos_comparativo %>%
  group_by(Version) %>%
  mutate(
    posicion_acumulada = cumsum(Porcentaje) - Porcentaje/2
  ) %>%
  ungroup()

# Bases N para etiquetas
base_n_comparativo <- datos_p30_completo %>%
  group_by(Version) %>%
  summarise(Base_N = n(), .groups = 'drop')

# Gráfico comparativo
if(nrow(datos_comparativo) > 0) {
  ggplot(datos_comparativo, aes(x = Version, y = Porcentaje, fill = reorder(Respuesta, -Orden))) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE), width = 0.7) +
    
    # Etiquetas de porcentaje
    geom_text(aes(label = percent(Porcentaje, accuracy = 1), y = posicion_acumulada),
              color = "white",
              fontface = "bold",
              size = 3.5) +
    
    # Etiquetas de Base N
    geom_text(data = base_n_comparativo,
              aes(x = Version, y = 1.05, label = paste0("N=", Base_N)),
              inherit.aes = FALSE,
              size = 4,
              fontface = "bold") +
    
    scale_fill_manual(
      values = paleta_discriminacion,
      name = ""
    ) +
    
    guides(fill = guide_legend(nrow = 1)) +
    
    scale_y_continuous(
      labels = percent,
      limits = c(0, 1.1),
      expand = c(0, 0)
    ) +
    
    coord_flip() +
    labs(
      title = "Percepción de atención discriminatoria o excluyente\nen establecimientos de salud",
      subtitle = "Comparativa de las tres versiones de filtrado",
      x = "",
      y = "¿Considera que el personal de salud brinda una atención\ndiscriminatoria o excluyente por ser migrante o refugiado?"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold", margin = margin(b = 10)),
      plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 15)),
      axis.text.y = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(size = 10),
      legend.position = "bottom",
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
    )
} else {
  cat("No hay datos para generar el gráfico comparativo\n")
}
```

```{r}
# 6. EXPORTACIÓN A EXCEL - TABLAS BASE DE LOS TRES GRÁFICOS P30

# Crear workbook
wb_p30 <- createWorkbook()

# Hoja 1: Resumen general comparativo
tabla_resumen_comparativo <- datos_comparativo %>%
  mutate(Porcentaje_Formateado = percent(Porcentaje, accuracy = 0.1)) %>%
  select(Version, Respuesta, Frecuencia, Porcentaje, Porcentaje_Formateado)

addWorksheet(wb_p30, "01_Resumen_Comparativo")
writeDataTable(wb_p30, "01_Resumen_Comparativo", tabla_resumen_comparativo)

# Hoja 2: Datos detallados Versión 1 (Sin filtros)
tabla_version1_detalle <- datos_version1 %>%
  select(Respuesta) %>%
  mutate(Version = "1. Total: Sin filtros")

addWorksheet(wb_p30, "02_Version1_SinFiltros")
writeDataTable(wb_p30, "02_Version1_SinFiltros", tabla_version1_detalle)

# Hoja 3: Datos detallados Versión 2 (P17_1=1 o P17_2=1)
if(nrow(datos_version2) > 0) {
  tabla_version2_detalle <- datos_version2 %>%
    select(P17_1, P17_2, Respuesta) %>%
    mutate(Version = "2. P17_1=1 o P17_2=1")
  
  addWorksheet(wb_p30, "03_Version2_P17_1_o_P17_2")
  writeDataTable(wb_p30, "03_Version2_P17_1_o_P17_2", tabla_version2_detalle)
}

# Hoja 4: Datos detallados Versión 3 (P18=1 o vacío)
if(nrow(datos_version3) > 0) {
  tabla_version3_detalle <- datos_version3 %>%
    select(P18, Respuesta) %>%
    mutate(Version = "3. P18=1 o vacío")
  
  addWorksheet(wb_p30, "04_Version3_P18_1_o_Vacio")
  writeDataTable(wb_p30, "04_Version3_P18_1_o_Vacio", tabla_version3_detalle)
}

# Hoja 5: Metodología y criterios
metodologia_p30 <- data.frame(
  Version = c(
    "1. Total: Sin filtros",
    "2. P17_1=1 o P17_2=1", 
    "3. P18=1 o vacío"
  ),
  Criterio_Inclusion = c(
    "Todos los encuestados que respondieron P30 (1=Siempre, 2=Frecuentemente, 3=Algunas veces)",
    "Encuestados que respondieron 'Sí' en P17_1 (confía en proveedores públicos) O 'Sí' en P17_2 (confía en tratamientos) Y respondieron P30",
    "Encuestados que respondieron P18=1 (recibió tratamiento) o P18 vacío (no se registró respuesta) Y respondieron P30"
  ),
  Base_N = c(
    nrow(datos_version1),
    nrow(datos_version2),
    nrow(datos_version3)
  ),
  Descripcion_Variables = c(
    "P30: Percepción de discriminación (1=Siempre, 2=Frecuentemente, 3=Algunas veces)",
    "P17_1: Confianza en proveedores de salud público\nP17_2: Confianza en tratamientos que prescriben",
    "P18: ¿Recibió tratamiento? (1=Sí, NA=No respondido/vacío)"
  )
)

addWorksheet(wb_p30, "05_Metodologia")
writeDataTable(wb_p30, "05_Metodologia", metodologia_p30)

# Hoja 6: Estadísticas descriptivas
estadisticas_p30 <- data.frame(
  Metrica = c(
    "Total encuestados en base original",
    "Versión 1 - Sin filtros",
    "Versión 2 - P17_1=1 o P17_2=1",
    "Versión 3 - P18=1 o vacío",
    "Porcentaje 'Siempre' - Versión 1",
    "Porcentaje 'Siempre' - Versión 2", 
    "Porcentaje 'Siempre' - Versión 3",
    "Porcentaje 'Siempre + Frecuentemente' - Versión 1",
    "Porcentaje 'Siempre + Frecuentemente' - Versión 2",
    "Porcentaje 'Siempre + Frecuentemente' - Versión 3"
  ),
  Valor = c(
    nrow(datos),
    nrow(datos_version1),
    nrow(datos_version2),
    nrow(datos_version3),
    percent(filter(tabla_resumen_comparativo, Version == "1. Total: Sin filtros" & Respuesta == "Siempre")$Porcentaje, accuracy = 0.1),
    ifelse(nrow(datos_version2) > 0, 
           percent(filter(tabla_resumen_comparativo, Version == "2. P17_1=1 o P17_2=1" & Respuesta == "Siempre")$Porcentaje, accuracy = 0.1),
           "N/A"),
    ifelse(nrow(datos_version3) > 0,
           percent(filter(tabla_resumen_comparativo, Version == "3. P18=1 o vacío" & Respuesta == "Siempre")$Porcentaje, accuracy = 0.1),
           "N/A"),
    # Siempre + Frecuentemente
    percent(sum(filter(tabla_resumen_comparativo, Version == "1. Total: Sin filtros" & Respuesta %in% c("Siempre", "Frecuentemente"))$Porcentaje), accuracy = 0.1),
    ifelse(nrow(datos_version2) > 0,
           percent(sum(filter(tabla_resumen_comparativo, Version == "2. P17_1=1 o P17_2=1" & Respuesta %in% c("Siempre", "Frecuentemente"))$Porcentaje), accuracy = 0.1),
           "N/A"),
    ifelse(nrow(datos_version3) > 0,
           percent(sum(filter(tabla_resumen_comparativo, Version == "3. P18=1 o vacío" & Respuesta %in% c("Siempre", "Frecuentemente"))$Porcentaje), accuracy = 0.1),
           "N/A")
  )
)

addWorksheet(wb_p30, "06_Estadisticas")
writeDataTable(wb_p30, "06_Estadisticas", estadisticas_p30)

# Hoja 7: Datos completos para análisis
datos_completos_export_p30 <- datos_p30_completo %>%
  select(Version, Respuesta)

addWorksheet(wb_p30, "07_Datos_Completos")
writeDataTable(wb_p30, "07_Datos_Completos", datos_completos_export_p30)

# Aplicar formatos
headerStyle <- createStyle(
  textDecoration = "bold", fgFill = "#002b4a", fontColour = "white",
  border = "TopBottomLeftRight", borderColour = "#002b4a"
)

# Aplicar estilo a todas las hojas
hojas_p30 <- sheets(wb_p30)
for (hoja in hojas_p30) {
  addStyle(wb_p30, hoja, headerStyle, rows = 1, cols = 1:10, gridExpand = TRUE)
  setColWidths(wb_p30, hoja, cols = 1:10, widths = "auto")
}

# Guardar archivo
ruta_excel_p30 <- "C:/Users/ASUS/Documents/OPS/Final/Entregables/Tablas_Base_P30_Discriminacion_Tres_Versiones.xlsx"
saveWorkbook(wb_p30, ruta_excel_p30, overwrite = TRUE)

cat("EXPORTACIÓN COMPLETADA P30\n")
cat("Archivo Excel generado:", ruta_excel_p30, "\n")
cat("Hojas incluidas:\n")
for(hoja in hojas_p30) {
  cat("  •", hoja, "\n")
}
cat("\n RESUMEN DE VERSIONES P30:\n")
cat("  • Versión 1 (Sin filtros):", nrow(datos_version1), "personas\n")
cat("  • Versión 2 (P17_1=1 o P17_2=1):", nrow(datos_version2), "personas\n")
cat("  • Versión 3 (P18=1 o vacío):", nrow(datos_version3), "personas\n")
```

